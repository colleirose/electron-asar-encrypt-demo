const { BrowserWindow, nativeImage } = require("electron");
const { format } = require("url");
const { join } = require("path");
const { existsSync } = require("fs");

function isPromiseLike(obj) {
    return (
        obj instanceof Promise ||
        (obj !== undefined &&
            obj !== null &&
            typeof obj.then === "function" &&
            typeof obj.catch === "function")
    );
}

class WindowManager {
    constructor() {
        if (WindowManager._instance) {
            throw new Error("Can not create multiple WindowManager instances.");
        }

        this.windows = new Map();
    }

    createWindow(name, browerWindowOptions, url, entry) {
        if (this.windows.has(name)) {
            throw new Error(`The window named "${name}" already exists.`);
        }

        if (!("icon" in browerWindowOptions)) {
            if (process.env.NODE_ENV !== "production") {
                const iconPath = join(
                    __dirname,
                    `../../../icon/app.${
                        process.platform === "win32" ? "ico" : "icns"
                    }`
                );
                if (existsSync(iconPath)) {
                    browerWindowOptions.icon =
                        nativeImage.createFromPath(iconPath);
                }
            }
        }

        let win = new BrowserWindow(browerWindowOptions);
        win.webContents.executeJavaScript(`!function () {
            require('./renderer.node');
            require('${entry}');
        }()`);

        win.on("ready-to-show", function () {
            if (!win) return;
            win.show();
            win.focus();
            win.webContents.openDevTools();
        });

        win.on("closed", () => {
            win = null;
            this.windows.delete(name);
        });

        this.windows.set(name, win);

        win.removeMenu ? win.removeMenu() : win.setMenu(null);

        const res = win.loadURL(url);

        if (isPromiseLike(res)) {
            res.catch((err) => {
                console.log(err);
            });
        }
    }

    getWindow(name) {
        if (this.windows.has(name)) {
            return this.windows.get(name);
        }

        throw new Error(`The window named "${name}" doesn't exist.`);
    }

    removeWindow(name) {
        if (!this.windows.has(name)) {
            throw new Error(`The window named "${name}" doesn't exist.`);
        }

        this.windows.get(name).close();
    }

    hasWindow(name) {
        return this.windows.has(name);
    }
}

WindowManager.getInstance = function () {
    if (!WindowManager._instance) {
        WindowManager._instance = new WindowManager();
    }

    return WindowManager._instance;
};

WindowManager.ID_MAIN_WINDOW = "main-window";

WindowManager.__SECRET_KEY__ = [];

WindowManager.createMainWindow = function () {
    const windowManager = WindowManager.getInstance();
    if (!windowManager.hasWindow(WindowManager.ID_MAIN_WINDOW)) {
        windowManager.createWindow(
            WindowManager.ID_MAIN_WINDOW,
            {
                width: 800,
                height: 600,
                show: false,
                webPreferences: {
                    nodeIntegration: true,
                    enableRemoteModule: false,
                    contextIsolation: false,
                    devTools: false
                }
            },
            format({
                pathname: join(__dirname, "./index.html"),
                protocol: "file:",
                slashes: true
            }),
            "./renderer/renderer.js"
        );
    }
};

module.exports = WindowManager;
